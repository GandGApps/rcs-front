name: Build and Publish Kassa.Wpf

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore 

    - name: Build project
      run: dotnet build --configuration Release ./Kassa.Wpf/Kassa.Wpf.csproj

    - name: Test
      run: dotnet test --no-restore --logger  "trx;LogFileName=test-results.trx" || true

    - name: Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: DotNET Tests
        path: "**/test-results.trx"                            
        reporter: dotnet-trx
        fail-on-error: true

    - name: Publish project
      run: dotnet publish --configuration Release --output ./output ./Kassa.Wpf/Kassa.Wpf.csproj

    - name: Commit and Push binaries
      env:
        GITHUB_TOKEN: ${{ secrets.KASSA_TOKEN }}
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git fetch origin
        git checkout -b bin origin/bin || git checkout -b bin
        git rm -rf .
        Copy-Item -Path ./output/* -Destination . -Recurse
        Remove-Item -Recurse -Force -Path ./output
        git add .
        git commit -m "Add published binaries"
        git push -u origin bin --force
      shell: pwsh

  build_laucnher:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Setup Msbuild
      uses: warrenbuckley/Setup-MSBuild@v1
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

    - name: Added runtime
      run: dotnet add Kassa.Launcher/Kassa.Launcher.csproj package Microsoft.NETCore.App.Runtime.win-x64 --version 8.0.7

    - name: Restore dependencies
      run: msbuild /t:Restore /p:RuntimeIdentifier=win-x64 /p:TargetFramework=net8.0 Kassa.Launcher/Kassa.Launcher.csproj

    - name: Build project
      run: msbuild /t:Build /p:Configuration=Release /p:TargetFramework=net8.0 /p:RuntimeIdentifier=win-x64 /p:OutputPath=./output Kassa.Launcher/Kassa.Launcher.csproj

    - name: Publish project
      run: msbuild /t:publish /p:Configuration=Release /p:TargetFramework=net8.0 /p:SelfContained=true /p:PublishReadyToRun=True -p:PublishSingleFile=true /p:RuntimeIdentifier=win-x64 /p:OutputPath=./output Kassa.Launcher/Kassa.Launcher.csproj

    - name: Commit and Push binaries
      env:
        GITHUB_TOKEN: ${{ secrets.KASSA_TOKEN }}
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git fetch origin
        git checkout -b launcher origin/launcher || git checkout -b launcher
        git rm -rf .
        Copy-Item -Path ./output/* -Destination . -Recurse
        Remove-Item -Recurse -Force -Path ./output
        git add .
        git commit -m "Add published binaries"
        git push -u origin launcher --force
      shell: pwsh